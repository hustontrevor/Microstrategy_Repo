DECLARE @Project as nvarchar(250);
SET @Project = 'MyProj';

WITH DIR AS (
	SELECT o.PROJECT_ID, o.OBJECT_ID, o.PARENT_ID, o.OBJECT_NAME Name, CAST('\' AS nvarchar(max)) Folder
	FROM DSSMDOBJINFO o
	WHERE o.PARENT_ID = '00000000-0000-0000-0000-000000000000'
	AND o.OBJECT_NAME <> 'Managed Objects'

	UNION ALL

	SELECT o.PROJECT_ID, o.OBJECT_ID, o.PARENT_ID, o.OBJECT_NAME Name, o2.Folder + o2.Name + '\' Folder
	FROM DSSMDOBJINFO o
	JOIN DIR o2 ON o.PARENT_ID = o2.OBJECT_ID AND o.PROJECT_ID = o2.PROJECT_ID
	WHERE o.OBJECT_NAME <> 'System Objects'
)

SELECT 
(Select p.object_name From DSSMDOBJINFO p Where p.object_id = o.project_id ) PROJECT
,s.RIGHTS 

-- B11 0000 0000 0000 0000 0000 1111 1111  == 29 bits
,CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS & 536870912 ) > 0 THEN '1' ELSE '0'   END +
 CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS & 268435456 ) > 0 THEN '1' ELSE '0'   END +
/*CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS & 32768 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS & 16384 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &  8192 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &  4096 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &  2048 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &  1024 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &   512 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &   256 ) > 0 THEN '1' ELSE '0'   END +*/
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &   128 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &    64 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &    32 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &    16 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &     8 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &     4 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &     2 ) > 0 THEN '1' ELSE '0'   END +
CASE WHEN CONVERT(VARCHAR(16), s.RIGHTS &     1 ) > 0 THEN '1' ELSE '0'   END RightsBinary


,CASE s.RIGHTS 
-- Convert to Binary and last 8 digits EUCDWR?B == Execute/Use/Control/Delete/Write/Read/?/Browse
-- Grant Object 1=Grant
WHEN 1 THEN '' -- b00000001WHEN 5 THEN 'Custom E0U0C0D0W0R1?1B1' -- b00000011WHEN 13 THEN '' -- b00001101WHEN 128 THEN 'Custom E1U0C0D0W0R0?0B0' -- b10000000WHEN 132 THEN '' -- b10000100WHEN 133 THEN '' -- b10000101WHEN 198 THEN 'Custom E1U1C0D0W0R1?1B0' -- b11000110WHEN 199 THEN 'View' -- b11000111WHEN 207 THEN 'Custom E1U1C0D0W1R1?1B1' -- b11001111WHEN 223 THEN 'Modify' -- b11011111WHEN 239 THEN '' -- b11101111WHEN 251 THEN '' -- b11111011WHEN 255 THEN 'Full Control' -- b11111111-- Deny Object   1==Deny
WHEN 268435504 THEN 'Custom E1U1C0D0W1R1?1B1'  -- B010000000000000000000000110000 ?? 0==grant
WHEN 268435505 THEN 'Custom E1U1C0D0W1R1?1B0'  -- B010000000000000000000000110001 ?? 0==default
WHEN 268435512 THEN 'Custom E1U1C0D0W0R1?1B1'  -- B010000000000000000000000111000
WHEN 268435513 THEN 'Custom E1U1C0D0W0R1?1B0'  -- B010000000000000000000000111001
WHEN 268435579 THEN 'Custom E1U0C0D0W0R1?0B0'  -- B010000000000000000000001111011
WHEN 268435583 THEN 'Custom E1U0C0D0W0R0?0B0'  -- B010000000000000000000001111111
WHEN 268435711 THEN 'Denied All'               -- B010000000000000000000011111111
-- Grant Child 
WHEN 536870913 THEN '-Child Custom E0U0C0D0W0R0?0B1'  -- B100000000000000000000000000001
WHEN 536870917 THEN '-Child Custom E0U0C0D0W0R1?0B1'  -- B100000000000000000000000000101
WHEN 536871110 THEN '-Child Custom E1U1C0D0W0R1?1B0'  -- B100000000000000000000011000110
WHEN 536871111 THEN '-Child View'  -- B100000000000000000000011000111
WHEN 536871119 THEN '-Child Custom E1U1C0D0W1R1?1B1'  -- B100000000000000000000011001111
WHEN 536871135 THEN '-Child Modify'  -- B100000000000000000000011011111
WHEN 536871167 THEN '-Child Full Control'      -- B100000000000000000000011111111
-- Deny Child
WHEN 805306369 THEN '-Child Custom E1U1C1D1W1R1?1B0'  -- B110000000000000000000000000001
WHEN 805306400 THEN '-Child Custom E1U1C0D1W1R1?1B1'  -- B110000000000000000000000100000
WHEN 805306416 THEN '-Child View'  -- B110000000000000000000000110000
WHEN 805306424 THEN '-Child Custom E1U1C0D0W0R1?1B1'  -- B110000000000000000000000111000
WHEN 805306425 THEN '-Child Custom E1U1C0D0W0R1?1B0'  -- B110000000000000000000000111001
WHEN 805306623 THEN '-Child Denied All'        -- B110000000000000000000011111111
-- ??
WHEN 1610612736 THEN ''  -- B1100000000000000000000000000000
ELSE 'Unknown' 
END RIGHTS

,ISNULL(STUFF((SELECT '; ' + CAST(CASE s1.RIGHTS 
-- Convert to Binary and last 8 digits EUCDWR?B == Execute/Use/Control/Delete/Write/Read/?/Browse
-- Grant Object 1=Grant
WHEN 1 THEN '' -- b00000001WHEN 5 THEN 'Custom E0U0C0D0W0R1?1B1' -- b00000011WHEN 13 THEN '' -- b00001101WHEN 128 THEN 'Custom E1U0C0D0W0R0?0B0' -- b10000000WHEN 132 THEN '' -- b10000100WHEN 133 THEN '' -- b10000101WHEN 198 THEN 'Custom E1U1C0D0W0R1?1B0' -- b11000110WHEN 199 THEN 'View' -- b11000111WHEN 207 THEN 'Custom E1U1C0D0W1R1?1B1' -- b11001111WHEN 223 THEN 'Modify' -- b11011111WHEN 239 THEN '' -- b11101111WHEN 251 THEN '' -- b11111011WHEN 255 THEN 'Full Control' -- b11111111-- Deny Object   1==Deny
WHEN 268435504 THEN 'Custom E1U1C0D0W1R1?1B1'  -- B010000000000000000000000110000 ?? 0==grant
WHEN 268435505 THEN 'Custom E1U1C0D0W1R1?1B0'  -- B010000000000000000000000110001 ?? 0==default
WHEN 268435512 THEN 'Custom E1U1C0D0W0R1?1B1'  -- B010000000000000000000000111000
WHEN 268435513 THEN 'Custom E1U1C0D0W0R1?1B0'  -- B010000000000000000000000111001
WHEN 268435579 THEN 'Custom E1U0C0D0W0R1?0B0'  -- B010000000000000000000001111011
WHEN 268435583 THEN 'Custom E1U0C0D0W0R0?0B0'  -- B010000000000000000000001111111
WHEN 268435711 THEN 'Denied All'               -- B010000000000000000000011111111
-- Grant Child 
WHEN 536870913 THEN '-Child Custom E0U0C0D0W0R0?0B1'  -- B100000000000000000000000000001
WHEN 536870917 THEN '-Child Custom E0U0C0D0W0R1?0B1'  -- B100000000000000000000000000101
WHEN 536871110 THEN '-Child Custom E1U1C0D0W0R1?1B0'  -- B100000000000000000000011000110
WHEN 536871111 THEN '-Child View'  -- B100000000000000000000011000111
WHEN 536871119 THEN '-Child Custom E1U1C0D0W1R1?1B1'  -- B100000000000000000000011001111
WHEN 536871135 THEN '-Child Modify'  -- B100000000000000000000011011111
WHEN 536871167 THEN '-Child Full Control'      -- B100000000000000000000011111111
-- Deny Child
WHEN 805306369 THEN '-Child Custom E1U1C1D1W1R1?1B0'  -- B110000000000000000000000000001
WHEN 805306400 THEN '-Child Custom E1U1C0D1W1R1?1B1'  -- B110000000000000000000000100000
WHEN 805306416 THEN '-Child View'  -- B110000000000000000000000110000
WHEN 805306424 THEN '-Child Custom E1U1C0D0W0R1?1B1'  -- B110000000000000000000000111000
WHEN 805306425 THEN '-Child Custom E1U1C0D0W0R1?1B0'  -- B110000000000000000000000111001
WHEN 805306623 THEN '-Child Denied All'        -- B110000000000000000000011111111
-- ??
WHEN 1610612736 THEN ''  -- B1100000000000000000000000000000
ELSE 'Unknown' 
END AS nVARCHAR(MAX))		
     FROM DSSMDOBJSECU s1  		
		JOIN DSSMDOBJINFO t1 ON s1.TRUST_ID = t1.OBJECT_ID
     WHERE s1.OBJECT_ID = o.OBJECT_ID AND s1.PROJECT_ID = o.PROJECT_ID 		
		AND t1.OBJECT_NAME = t.OBJECT_NAME		
     GROUP BY s1.rights	
     ORDER BY s1.rights	
     FOR XML PATH('')),1,1,''),' ') [OTHER RIGHTS]	

,dbo.fn_UniqueidentifierToCharMSTR(o.OBJECT_ID) GUID
,o.OBJECT_NAME
,d.folder
, case o.object_type
	when 1 then 'filter' when 2 then 'template' when 3 then 'report' when 4 then 'metric' when 6 then 'autostyle'
	when 8 then 'folder' when 10 then 'prompt' when 11 then 'function' when 12 then 'attribute' when 13 then 'fact'
	when 14 then 'hierarchy' when 15 then 'table' when 18 then 'shortcut' when 21 then 'attribute id' when 22 then 'schema'
	when 23 then 'cell format' when 24 then 'warehouse catalog' when 25 then 'warehouse catalog definition' when 26 then 'table column'
	when 28 then 'property sets' when 34 then 'users/groups' when 39 then 'search' when 42 then 'package' when 43 then 'transformation'
	when 47 then 'consolidations' when 52 then 'link' when 53 then 'warehouse table' when 55 then 'document' when 56 then 'drill map'
	when 58 then 'security filter' when 60 then 'answer' when 61 then 'graph style' when 71 then 'palette' else 'OTHERS'
end AS OBJ_TYPE
,t.OBJECT_NAME GROUP_NAME


,ISNULL(STUFF((SELECT '; ' + CAST(t1.OBJECT_NAME AS nVARCHAR(MAX))		
     FROM DSSMDOBJSECU s1  		
		JOIN DSSMDOBJINFO t1 ON s1.TRUST_ID = t1.OBJECT_ID
     WHERE s1.OBJECT_ID = o.OBJECT_ID AND s1.PROJECT_ID = o.PROJECT_ID 		
		--AND s1.rights IN (128,268435583,   268435711,805306623) -- see OBJ Security.sql for list of values
		AND ( t1.OBJECT_NAME NOT LIKE '%XXXXX%' AND t1.OBJECT_NAME NOT LIKE '%XXXXX%' )
		AND t1.OBJECT_NAME NOT IN ('Administrator','Administrators','Local')
     GROUP BY t1.OBJECT_NAME	
     ORDER BY t1.OBJECT_NAME	
     FOR XML PATH('')),1,1,''),' ') [OTHER ACCESS]	

,(SELECT COUNT(*) FROM DSSMDOBJDEPN dp WHERE dp.PROJECT_ID = o.PROJECT_ID AND dp.OBJECT_ID = o.OBJECT_ID ) ComponentCount
,(SELECT COUNT(*) FROM DSSMDOBJDEPN dp WHERE dp.PROJECT_ID = o.PROJECT_ID AND dp.depn_objID = o.OBJECT_ID ) DependentCount

FROM DSSMDOBJINFO o
JOIN DSSMDOBJSECU s ON s.OBJECT_ID = o.OBJECT_ID AND s.PROJECT_ID = o.PROJECT_ID
JOIN DSSMDOBJINFO t ON s.TRUST_ID = t.OBJECT_ID --AND t.PROJECT_ID = o.PROJECT_ID --Users and groups dont use Project the same way

JOIN DIR d ON o.OBJECT_ID = d.OBJECT_ID AND d.PROJECT_ID = o.PROJECT_ID


WHERE 
o.PROJECT_ID = (Select p.object_id From DSSMDOBJINFO p Where p.OBJECT_NAME = @Project AND p.OBJECT_TYPE = 32)
--AND o.OBJECT_ID = dbo.fn_CharToUniqueidentifier('D0FF079A43FD6B145291FEB4569FA668')

--AND o.OBJECT_TYPE = 8  -- Folders only

--AND ( t.OBJECT_NAME LIKE '%XXXXX%' OR t.OBJECT_NAME LIKE '%XXXXX%' )
AND t.OBJECT_NAME NOT IN ('Administrator','Administrators','Local','Everyone')
AND t.SUBTYPE = 8704 -- Users only

AND d.Folder NOT LIKE '%\Profiles\%'

and s.RIGHTS <= 268435711  -- ignore Child rights




order by d.Folder + o.OBJECT_NAME, t.OBJECT_NAME, s.rights 